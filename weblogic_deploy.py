import requests
import re
import time
from argparse import ArgumentParser

parser = ArgumentParser()
parser.add_argument("-u", dest="url", help="Target URL")
parser.add_argument("-l", dest="login", help="Credentials-Login")
parser.add_argument("-p", dest="pwd", help="Credentials-Password")
parser.add_argument("-f", dest="file", help="WAR to deploy,C:\PT8.50\webserv\peoplesoft\upload\Calendar.war ")
args = parser.parse_args()
session = requests.Session()
#Get Cookie
paramsPost = {"j_username": args.login, "j_password": args.pwd}
request = session.post(args.url+"/console/j_security_check", data=paramsPost)
cookies= requests.utils.dict_from_cookiejar(session.cookies)
time.sleep(1)
#Get frsc token
requestN = session.get(args.url+"/console/console.portal?_nfpb=true&_pageLabel=AppApplicationInstallPage", cookies=cookies,allow_redirects=False)
result = re.finditer( '0x[0-9a-f]{48}', requestN.text )
for match in result:
    frsc = match.group()
print "OK, frsc token is:"+frsc
time.sleep(1)
#1_appSelected
paramsPost = {"AppApplicationInstallPortletselectedAppPath": args.file, "AppApplicationInstallPortletfrsc": frsc}
requestA = session.post(args.url+"/console/console.portal?AppApplicationInstallPortlet_actionOverride=/com/bea/console/actions/app/install/appSelected", cookies=cookies,data=paramsPost)
print "Select WAR file,status::::", requestA.status_code
time.sleep(1)
###2
paramsPost = {"AppApplicationInstallPortlettargetStyle": "Application", "AppApplicationInstallPortletfrsc": frsc}
requestA = session.post(args.url+"/console/console.portal?AppApplicationInstallPortlet_actionOverride=/com/bea/console/actions/app/install/targetStyleSelected", cookies=cookies,data=paramsPost)
print "Preparing..Stage 1.Status::::", requestA.status_code
time.sleep(1)
###3
paramsPost = {"AppApplicationInstallPortletname": "Calendar2","AppApplicationInstallPortletsecurityModel":"DDOnly" ,"AppApplicationInstallPortletstagingStyle":"Default","AppApplicationInstallPortletnoStageSourcePath":args.file,"AppApplicationInstallPortletfrsc": frsc}
requestA = session.post(args.url+"/console/console.portal?AppApplicationInstallPortlet_actionOverride=/com/bea/console/actions/app/install/saveIdentity", cookies=cookies,data=paramsPost)
print "Preparing..Stage 2.Status::::", requestA.status_code
time.sleep(1)
###4
paramsPost = {"AppApplicationInstallPortletconfigurationAction": "Yes","AppApplicationInstallPortletfrsc": frsc}
requestA = session.post(args.url+"/console/console.portal?AppApplicationInstallPortlet_actionOverride=/com/bea/console/actions/app/install/finish", cookies=cookies,data=paramsPost)
print "Preparing..Stage 3.Status::::", requestA.status_code
time.sleep(1)
###5
paramsPost = {"AppApplicationInstallPortletconfigurationAction": "Yes","AppApplicationInstallPortletfrsc": frsc}
requestA = session.post(args.url+"/console/console.portal?AppApplicationInstallPortlet_actionOverride=/com/bea/console/actions/app/install/finish", cookies=cookies,data=paramsPost)
print "Finish!Now we need turn ON war.Status::::", requestA.status_code

###5.1ButtonClick
paramsPost = {"AppControlStartPortletchosenContents": "com.bea.console.handles.AppDeploymentHandle(%22com.bea%3AName%3DCalendar2%2CType%3DAppDeployment%22)","_pageLabel":"AppControlStartPage","_nfpb":"true","AppControlStartPortletfrsc": frsc}
requestA = session.post("http://172.16.0.136/console/console.portal?AppControlStartPortletreturnTo=AppDeploymentsControlPage&AppDeploymentsControlPortlethandle=com.bea.console.handles.JMXHandle%28%22com.bea%3AName%3Dpeoplesoft%2CType%3DDomain%22%29", cookies=cookies,data=paramsPost)
print "Starting WAR file.Status:::", requestA.status_code 

#6

paramsPost = {"AppControlStartPortletfrsc": frsc}
requestA = session.post(url="http://172.16.0.136/console/console.portal?AppControlStartPortlet_actionOverride=/com/bea/console/actions/app/controlstart/finish", cookies=cookies,data=paramsPost)
print "OK!Check http://ip/Calendar	Status::::", requestA.status_code 

